<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>reaction-sync</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script>
      function onYouTubeIframeAPIReady() {
        window.youtubeAPIReady = true;
        const event = new CustomEvent('youtube-api-ready');
        window.dispatchEvent(event);
      }
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      tag.onload = function() {
      };
      tag.onerror = function() {
        console.error("Failed to load YouTube API");
        setTimeout(function() {
          var newTag = document.createElement('script');
          newTag.src = "https://www.youtube.com/iframe_api";
          document.head.appendChild(newTag);
        }, 2000);
      };
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P8C85TVE0N"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag("js", new Date());
      gtag("config", "G-P8C85TVE0N");
    </script>
    <script type="module" src="js/app.js"></script>
    <script type="module" src="js/custom-controls.js"></script>
    <script type="module" src="js/progress.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Setup dropdown menus
        function setupDropdownMenu(buttonId, menuId) {
          const button = document.getElementById(buttonId);
          const menu = document.getElementById(menuId);
          
          button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Hide all other menus
            document.querySelectorAll('.video-source-menu').forEach(m => {
              if (m !== menu) m.style.display = 'none';
            });
            
            // Toggle this menu
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
          });
        }
        
        // Setup both dropdown menus
        setupDropdownMenu('baseVideoSourceBtn', 'baseVideoSourceMenu');
        setupDropdownMenu('reactVideoSourceBtn', 'reactVideoSourceMenu');
        
        // Hide menus when clicking outside
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.video-source-dropdown')) {
            document.querySelectorAll('.video-source-menu').forEach(m => {
              m.style.display = 'none';
            });
          }
        });
        
        // Base video handlers
        document.getElementById('addBaseVideoLocal').addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          document.getElementById('baseVideoSourceMenu').style.display = 'none';
          if (window.selectVideo) window.selectVideo("#videoBaseLocal", null, false);
        });
        document.getElementById('addBaseVideoLink').addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          document.getElementById('baseVideoSourceMenu').style.display = 'none';
          if (window.selectVideo) window.selectVideo("#videoBaseLocal", null, true);
        });
        
        // React video handlers
        document.getElementById('addReactVidLocal').addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          document.getElementById('reactVideoSourceMenu').style.display = 'none';
          if (window.selectVideo) window.selectVideo("#videoReact", function(file) {
            if (file && file.name) {
              let tokens = file.name.split(".");
              let num = tokens.find(token => token.split("dt")[0] == "" && !isNaN(token.split("dt")[1]));
              if (num) {
                num = num.split("dt")[1];
                if (window.setDelay) window.setDelay(Number(num) / 10);
              }
            }
          }, false);
        });
        document.getElementById('addReactVidLink').addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          document.getElementById('reactVideoSourceMenu').style.display = 'none';
          if (window.selectVideo) window.selectVideo("#videoReact", function(file) {
            if (typeof file === 'object' && file.name) {
              let tokens = file.name.split(".");
              let num = tokens.find(token => token.split("dt")[0] == "" && !isNaN(token.split("dt")[1]));
              if (num) {
                num = num.split("dt")[1];
                if (window.setDelay) window.setDelay(Number(num) / 10);
              }
            }
          }, true);
        });
        document.getElementById('addSubBtn').addEventListener('click', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          if (window.loadSubtitles) window.loadSubtitles();
        });
        document.getElementById('syncButton').addEventListener('click', function() {
          if (window.syncNow) {
            window.syncNow();
          } else {
            console.error('syncNow function not available');
          }
        });
        document.getElementById('desyncButton').addEventListener('click', function() {
          if (window.disableSync) {
            window.disableSync();
          } else {
            console.error('disableSync function not available');
          }
        });
        const saveNowBtn = document.getElementById('saveNowButton');
        if (saveNowBtn) saveNowBtn.addEventListener('click', function(){ try { if (window.Progress && typeof window.Progress.saveNow==='function') window.Progress.saveNow(); } catch(e) {} });
        const tipsCloseBtn = document.getElementById('tipsClose');
        if (tipsCloseBtn) tipsCloseBtn.addEventListener('click', function(){ document.getElementById('tipsScreen').style.display = 'none'; });
        const loadLastBtn = document.getElementById('loadLastPairBtn');
        if (loadLastBtn) loadLastBtn.addEventListener('click', function(){ if (window.Progress && typeof window.Progress.loadLastPair==='function') window.Progress.loadLastPair(); });
        const clearBtn = document.getElementById('clearStorageBtn');
        if (clearBtn) clearBtn.addEventListener('click', function(){
          if (!confirm('Clear saved video progress?')) return;
          try {
            const keys=[]; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k&&k.startsWith('rsync:')) keys.push(k);} keys.forEach(k=>localStorage.removeItem(k));
          } catch(e) {}
          alert('Saved progress cleared.');
        });
      });
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      /* ========================================
         CSS DESIGN TOKENS & VARIABLES
         ======================================== */
      :root {
        /* Colors - Primary */
        --color-bg-primary: rgba(8, 10, 15, 0.85);
        --color-bg-secondary: rgba(15, 18, 25, 0.9);
        --color-bg-elevated: rgba(22, 26, 35, 0.95);
        
        /* Colors - Accent */
        --color-accent-cyan: #00d4ff;
        --color-accent-cyan-dim: rgba(0, 212, 255, 0.6);
        --color-accent-amber: #ffb300;
        --color-accent-amber-dim: rgba(255, 179, 0, 0.6);
        --color-accent-green: #00e676;
        --color-accent-green-dim: rgba(0, 230, 118, 0.4);
        --color-accent-red: #ff5252;
        
        /* Colors - Text */
        --color-text-primary: #f0f0f0;
        --color-text-secondary: #a0a8b8;
        --color-text-muted: #6b7280;
        
        /* Colors - Borders */
        --color-border-subtle: rgba(255, 255, 255, 0.06);
        --color-border-medium: rgba(255, 255, 255, 0.12);
        --color-border-accent: rgba(0, 212, 255, 0.3);
        
        /* Spacing */
        --space-xs: 2px;
        --space-sm: 4px;
        --space-md: 8px;
        --space-lg: 12px;
        --space-xl: 16px;
        
        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 10px;
        --radius-full: 50%;
        
        /* Typography */
        --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
        --font-size-xs: 9px;
        --font-size-sm: 10px;
        --font-size-md: 11px;
        --font-size-lg: 12px;
        
        /* Shadows */
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.35);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
        --shadow-glow-cyan: 0 0 12px rgba(0, 212, 255, 0.4);
        --shadow-glow-green: 0 0 12px rgba(0, 230, 118, 0.4);
        --shadow-glow-amber: 0 0 12px rgba(255, 179, 0, 0.4);
        
        /* Transitions */
        --transition-fast: 0.15s ease;
        --transition-normal: 0.25s ease;
        
        /* Control Bar */
        --control-height: 42px;
        --control-btn-size: 28px;
        --control-btn-size-sm: 24px;
      }
      
      /* ========================================
         BASE STYLES
         ======================================== */
      html, body { 
        padding: 0; 
        margin: 0; 
        overflow: hidden; 
        width: 100vw; 
        height: 100vh; 
        background: #000; 
        font-family: var(--font-sans); 
        position: relative; 
        z-index: 0; 
        -webkit-font-smoothing: antialiased;
      }
      
      input, button { cursor: pointer; }
      
      /* ========================================
         VIDEO CONTAINERS
         ======================================== */
      #videoBase { background: #000; width: 100%; z-index: 1; max-height: 100vh; object-fit: contain; }
      #videoBaseContainer { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; overflow: hidden; z-index: 1; pointer-events: none !important; }
      #videoBaseYoutube { position: absolute; top: 0; left: 0; width: 100% !important; height: calc(100% - var(--control-height)) !important; background: black; pointer-events: auto !important; }
      #videoBaseLocal { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - var(--control-height)) !important; object-fit: contain; pointer-events: auto !important; }
      
      /* React Video Container */
      #videoReactContainer { 
        position: fixed !important; 
        z-index: 100; 
        top: 1vw; 
        left: 1vw; 
        border-radius: var(--radius-lg); 
        border: 2px solid var(--color-border-medium); 
        box-shadow: var(--shadow-md); 
        transition: border-color var(--transition-normal), box-shadow var(--transition-normal); 
        background: transparent; 
        min-width: 200px; 
        min-height: 112px; 
        overflow: visible !important; 
        resize: none !important; 
        transform: none !important; 
        will-change: auto; 
        touch-action: none; 
        cursor: default !important;
      }
      #videoReactContainer:hover { border-color: var(--color-accent-amber-dim); }
      #videoReactContainer.resizing { border-color: var(--color-accent-cyan); box-shadow: var(--shadow-glow-cyan); pointer-events: auto !important; user-select: none !important; }
      #videoReactContainer.resizing .ui-resizable-se { opacity: 1 !important; background: var(--color-accent-cyan) !important; z-index: 1003 !important; }
      #videoReactContainer.ui-resizable { touch-action: none !important; }
      #videoReact { width: 100% !important; height: 100% !important; border-radius: var(--radius-lg); object-fit: contain !important; background: #000; transform: translateZ(0); }
      #videoReactYoutube { width: 100% !important; border-radius: var(--radius-lg) var(--radius-lg) 0 0; background: #000; overflow: hidden; position: absolute; z-index: 4; pointer-events: none; }
      #videoReactYoutube iframe { pointer-events: none !important; width: 100% !important; height: 100% !important; }
      
      /* ========================================
         REACT VIDEO CONTROLS
         ======================================== */
      .reactControls { 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: 36px; 
        background: var(--color-bg-primary);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--color-border-subtle);
        border-top: 1px solid rgba(255, 179, 0, 0.15);
        display: flex; 
        align-items: center; 
        padding: 0 var(--space-md); 
        border-radius: 0 0 var(--radius-lg) var(--radius-lg); 
        z-index: 200; 
        opacity: 0; 
        transition: opacity var(--transition-normal); 
        gap: var(--space-md); 
        pointer-events: auto;
      }
      #videoReactContainer:hover .reactControls { opacity: 1; }
      #videoReactContainer:hover #reactDragHandle { opacity: 0.7 !important; }
      
      /* React Drag Handle */
      #reactDragHandle { 
        position: absolute; 
        top: 50% !important; 
        left: 5px !important; 
        transform: translateY(-50%) !important; 
        background: var(--color-bg-elevated) !important; 
        color: var(--color-text-secondary); 
        padding: 8px 4px !important; 
        border-radius: var(--radius-md) !important; 
        font-size: 8px !important; 
        font-family: var(--font-sans);
        font-weight: 600;
        letter-spacing: 0.5px;
        cursor: move; 
        z-index: 1001 !important; 
        backdrop-filter: blur(8px); 
        border: 1px solid var(--color-border-medium); 
        transition: all var(--transition-fast); 
        display: block; 
        writing-mode: vertical-rl; 
        text-transform: uppercase; 
        white-space: nowrap; 
        pointer-events: auto !important; 
        opacity: 0.3 !important;
      }
      #reactDragHandle:hover { 
        background: var(--color-bg-secondary) !important; 
        transform: translateY(-50%) scale(1.05) !important; 
        box-shadow: var(--shadow-sm);
        color: var(--color-text-primary);
      }
      #reactDragHandle::before { content: ''; display: none; }
      
      /* React Play Button */
      #reactPlayPauseInner {
        background: linear-gradient(145deg, var(--color-accent-amber), #f59e0b) !important;
        border: none !important;
        border-radius: var(--radius-full) !important;
        width: 22px !important;
        height: 22px !important;
        min-width: 22px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #1a1a1a !important;
        font-size: 9px !important;
        transition: all var(--transition-fast) !important;
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
      }
      #reactPlayPauseInner:hover {
        transform: scale(1.1) !important;
        box-shadow: var(--shadow-glow-amber) !important;
      }
      
      /* React Seek & Volume */
      #reactSeekBar { flex: 1; margin: 0 var(--space-sm); height: 3px; }
      #reactVolumeSlider { width: 50px; margin: 0; }
      
      #reactSeekBar, #reactVolumeSlider {
        background: rgba(255, 255, 255, 0.1) !important;
        border-radius: 2px !important;
        outline: none !important;
      }
      #reactSeekBar::-webkit-slider-thumb, #reactVolumeSlider::-webkit-slider-thumb {
        appearance: none !important;
        width: 10px !important;
        height: 10px !important;
        border-radius: var(--radius-full) !important;
        background: var(--color-accent-amber) !important;
        cursor: pointer !important;
        border: none !important;
        transition: all var(--transition-fast) !important;
      }
      #reactSeekBar::-webkit-slider-thumb:hover, #reactVolumeSlider::-webkit-slider-thumb:hover {
        transform: scale(1.3) !important;
        box-shadow: var(--shadow-glow-amber) !important;
      }
      
      #reactTimeDisplay {
        font-size: var(--font-size-xs) !important;
        color: var(--color-text-secondary) !important;
        font-family: var(--font-mono) !important;
        font-weight: 500 !important;
        min-width: 70px;
        text-align: center;
      }
      
      .timeDisplay { color: white; font-weight: bold; min-width: 70px; font-size: 0.8em; text-align: center; }
      
      /* ========================================
         RESIZABLE HANDLES
         ======================================== */
      .ui-resizable-handle { position: absolute; background: rgba(255, 255, 255, 0.15); width: 10px; height: 10px; display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 1000 !important; pointer-events: auto; }
      .ui-resizable-se { 
        width: 18px !important; 
        height: 18px !important; 
        background: var(--color-accent-cyan-dim) !important;
        cursor: se-resize !important; 
        z-index: 1002 !important; 
        bottom: 0 !important; 
        right: 0 !important; 
        display: block !important; 
        visibility: visible !important; 
        opacity: 0.7 !important; 
        pointer-events: auto !important; 
        position: absolute !important; 
        border-radius: var(--radius-sm) 0 var(--radius-lg) 0; 
        transition: all var(--transition-fast);
      }
      .ui-resizable-se:hover { 
        background: var(--color-accent-cyan) !important; 
        box-shadow: var(--shadow-glow-cyan);
        opacity: 1 !important;
      }
      .ui-resizable-helper { border: 2px solid var(--color-accent-cyan); background: rgba(0, 212, 255, 0.1); }
      html.ui-resizable, body.ui-resizable { cursor: default !important; }
      .ui-resizable:not(#videoReactContainer) { cursor: default !important; }
      #videoReactContainer .ui-resizable-se { cursor: se-resize !important; }
      
      /* ========================================
         MAIN CONTROL BAR
         ======================================== */
      #baseVideoControls { 
        position: absolute; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: var(--control-height); 
        background: var(--color-bg-primary);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-top: 1px solid var(--color-border-subtle);
        display: flex; 
        align-items: center; 
        padding: 0 var(--space-lg); 
        opacity: 0; 
        transition: opacity var(--transition-normal); 
        gap: var(--space-sm); 
        pointer-events: auto !important; 
        z-index: 50;
      }
      body:hover #baseVideoControls { opacity: 1; }
      #baseVideoControls * { pointer-events: auto !important; position: relative; }
      #baseVideoControls button { position: relative; z-index: 1000; transform: translateZ(0); will-change: transform; }
      
      /* ========================================
         CONTROL GROUPS
         ======================================== */
      .control-group {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: 0 var(--space-sm);
        position: relative;
      }
      
      .control-group.playback-group {
        flex-shrink: 0;
      }
      
      .control-group.seek-group {
        flex: 1;
        min-width: 100px;
      }
      
      .control-group.delay-group {
        flex-shrink: 0;
        background: var(--color-bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-xs) var(--space-md);
        border: 1px solid var(--color-border-subtle);
      }
      
      .control-group.media-group {
        flex-shrink: 0;
      }
      
      .control-group.sync-group {
        flex-shrink: 0;
        background: var(--color-bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--space-xs) var(--space-sm);
        border: 1px solid var(--color-border-subtle);
      }
      
      /* Vertical Separator */
      .control-separator {
        width: 1px;
        height: 20px;
        background: var(--color-border-medium);
        margin: 0 var(--space-sm);
        flex-shrink: 0;
      }
      
      /* ========================================
         BUTTONS
         ======================================== */
      button { 
        background: var(--color-bg-elevated); 
        color: var(--color-text-primary); 
        border: 1px solid var(--color-border-subtle); 
        padding: var(--space-sm) var(--space-md); 
        border-radius: var(--radius-md); 
        transition: all var(--transition-fast); 
        margin: 0;
        font-family: var(--font-sans);
        font-size: var(--font-size-sm);
        font-weight: 500;
      }
      button:hover { 
        background: var(--color-bg-secondary); 
        border-color: var(--color-border-medium);
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(0);
      }
      
      /* Compact Button */
      .compact-btn {
        padding: var(--space-xs) var(--space-md) !important;
        font-size: var(--font-size-sm) !important;
        min-width: auto !important;
        height: var(--control-btn-size-sm) !important;
        background: var(--color-bg-elevated) !important;
        border: 1px solid var(--color-border-subtle) !important;
        border-radius: var(--radius-md) !important;
        color: var(--color-text-secondary) !important;
        transition: all var(--transition-fast) !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
      .compact-btn:hover {
        background: rgba(0, 212, 255, 0.15) !important;
        border-color: var(--color-accent-cyan-dim) !important;
        color: var(--color-text-primary) !important;
        box-shadow: 0 2px 8px rgba(0, 212, 255, 0.15) !important;
      }
      
      /* Ultra Compact (for grouped buttons) */
      .ultra-compact {
        padding: var(--space-xs) var(--space-sm) !important;
        font-size: var(--font-size-xs) !important;
        min-width: 22px !important;
        height: 22px !important;
      }
      
      /* Play/Pause Button */
      #basePlayPause {
        background: linear-gradient(145deg, var(--color-accent-cyan), #0ea5e9) !important;
        border: none !important;
        border-radius: var(--radius-full) !important;
        width: var(--control-btn-size) !important;
        height: var(--control-btn-size) !important;
        min-width: var(--control-btn-size) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #0a0a0a !important;
        font-size: 11px !important;
        transition: all var(--transition-fast) !important;
        box-shadow: var(--shadow-sm);
        flex-shrink: 0;
      }
      #basePlayPause:hover {
        transform: scale(1.08) !important;
        box-shadow: var(--shadow-glow-cyan) !important;
      }
      
      /* ========================================
         SYNC BUTTON STATES
         ======================================== */
      #syncButton {
        transition: all var(--transition-fast) !important;
      }
      #syncButton.synced {
        background: linear-gradient(145deg, var(--color-accent-green), #10b981) !important;
        border-color: var(--color-accent-green) !important;
        color: #0a0a0a !important;
        box-shadow: var(--shadow-glow-green) !important;
        font-weight: 600 !important;
      }
      #syncButton.synced:hover {
        background: linear-gradient(145deg, #34d399, var(--color-accent-green)) !important;
        transform: translateY(-1px) !important;
      }
      
      /* Desync Button */
      #desyncButton {
        transition: all var(--transition-fast) !important;
      }
      #desyncButton:hover {
        background: rgba(255, 82, 82, 0.2) !important;
        border-color: var(--color-accent-red) !important;
        color: var(--color-accent-red) !important;
      }
      
      /* Force Resync Button */
      #forceResyncButton:hover {
        background: rgba(255, 179, 0, 0.2) !important;
        border-color: var(--color-accent-amber) !important;
        color: var(--color-accent-amber) !important;
      }
      
      /* Save Button */
      #saveNowButton:hover {
        background: rgba(0, 230, 118, 0.15) !important;
        border-color: var(--color-accent-green) !important;
      }
      
      /* Active/Focus States */
      .compact-btn:active {
        transform: scale(0.95) !important;
      }
      .compact-btn:focus-visible {
        outline: 2px solid var(--color-accent-cyan);
        outline-offset: 2px;
      }
      
      /* ========================================
         SEEK BAR
         ======================================== */
      input[type="range"] { 
        appearance: none; 
        background: transparent; 
        border-radius: var(--radius-sm); 
        height: 16px; 
        outline: none; 
        position: relative; 
        z-index: 1000; 
        pointer-events: all !important;
        margin: 0;
      }
      input[type="range"]::-webkit-slider-runnable-track { 
        appearance: none; 
        height: 4px; 
        background: rgba(255, 255, 255, 0.15); 
        border-radius: 2px; 
      }
      input[type="range"]::-webkit-slider-thumb { 
        appearance: none; 
        height: 12px; 
        width: 12px; 
        margin-top: -4px; 
        border-radius: var(--radius-full); 
        background: var(--color-accent-cyan); 
        cursor: pointer; 
        transition: all var(--transition-fast); 
        border: none;
      }
      input[type="range"]:hover::-webkit-slider-thumb { 
        transform: scale(1.2); 
        box-shadow: var(--shadow-glow-cyan);
      }
      input[type="range"]:active::-webkit-slider-thumb { 
        transform: scale(1.4); 
      }
      
      #baseSeekBar {
        flex: 1;
        margin: 0 var(--space-sm);
        height: 20px;
      }
      #baseSeekBar::-webkit-slider-runnable-track {
        height: 5px;
        background: linear-gradient(90deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08));
        border-radius: 3px;
      }
      #baseSeekBar::-webkit-slider-thumb {
        width: 14px;
        height: 14px;
        margin-top: -5px;
        background: linear-gradient(145deg, var(--color-accent-cyan), #0ea5e9);
        box-shadow: var(--shadow-sm);
      }
      
      /* Volume Slider */
      #baseVolumeSlider {
        width: 60px;
        height: 16px;
      }
      #baseVolumeSlider::-webkit-slider-runnable-track {
        height: 3px;
      }
      #baseVolumeSlider::-webkit-slider-thumb {
        width: 10px;
        height: 10px;
        margin-top: -4px;
        background: var(--color-accent-green);
      }
      #baseVolumeSlider:hover::-webkit-slider-thumb {
        box-shadow: var(--shadow-glow-green);
      }
      
      /* ========================================
         TIME DISPLAY
         ======================================== */
      .compact-time {
        font-size: var(--font-size-sm) !important;
        color: var(--color-text-secondary) !important;
        font-weight: 500 !important;
        font-family: var(--font-mono) !important;
        white-space: nowrap;
        min-width: 75px;
        text-align: center;
      }
      
      /* ========================================
         DELAY CONTROLS
         ======================================== */
      #delayControls { 
        display: inline-flex; 
        align-items: center; 
        gap: var(--space-sm); 
        justify-content: center; 
        flex-shrink: 0; 
      }
      #delayControls button { 
        flex: 0 0 auto; 
        width: 20px; 
        min-width: 20px; 
      }
      .delayLabel { 
        color: var(--color-text-muted); 
        font-size: var(--font-size-xs); 
        font-family: var(--font-mono);
        font-weight: 500;
        flex-shrink: 0; 
      }
      #delay { 
        min-width: 58px;
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        background: var(--color-bg-primary); 
        padding: var(--space-xs) var(--space-sm); 
        border-radius: var(--radius-sm); 
        font-size: var(--font-size-sm); 
        font-family: var(--font-mono); 
        font-weight: 500;
        color: var(--color-text-primary); 
        flex-shrink: 0; 
        text-align: center;
        border: 1px solid var(--color-border-subtle);
      }
      
      /* Sync Health Dot */
      #syncHealthDot { 
        width: 6px; 
        height: 6px; 
        border-radius: var(--radius-full); 
        background: var(--color-text-muted); 
        margin-left: var(--space-xs); 
        flex-shrink: 0; 
        transition: all var(--transition-normal); 
      }
      #syncHealthDot.healthy { background: var(--color-accent-green); box-shadow: 0 0 6px var(--color-accent-green); }
      #syncHealthDot.correcting { background: var(--color-accent-amber); box-shadow: 0 0 6px var(--color-accent-amber); }
      #syncHealthDot.drifting { background: var(--color-accent-red); box-shadow: 0 0 6px var(--color-accent-red); }
      
      /* ========================================
         DROPDOWN MENUS
         ======================================== */
      .video-source-dropdown {
        position: relative;
        display: inline-block;
      }
      .video-source-menu {
        position: absolute;
        bottom: calc(100% + var(--space-sm));
        left: 50%;
        transform: translateX(-50%);
        background: var(--color-bg-elevated);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--color-border-medium);
        border-radius: var(--radius-md);
        display: none;
        flex-direction: column;
        min-width: 70px;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        animation: dropdownIn 0.15s ease;
      }
      @keyframes dropdownIn {
        from { opacity: 0; transform: translateX(-50%) translateY(4px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
      .video-source-option {
        padding: var(--space-md) var(--space-lg);
        color: var(--color-text-secondary);
        background: transparent;
        border: none;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: var(--font-size-sm);
        font-weight: 500;
        font-family: var(--font-sans);
      }
      .video-source-option:hover {
        background: rgba(0, 212, 255, 0.15);
        color: var(--color-text-primary);
      }
      .video-source-option:first-child {
        border-bottom: 1px solid var(--color-border-subtle);
      }
      
      /* Base Source Button */
      #baseVideoSourceBtn:hover {
        background: rgba(0, 212, 255, 0.2) !important;
        border-color: var(--color-accent-cyan) !important;
        color: var(--color-accent-cyan) !important;
      }
      
      /* React Source Button */
      #reactVideoSourceBtn:hover {
        background: rgba(255, 179, 0, 0.2) !important;
        border-color: var(--color-accent-amber) !important;
        color: var(--color-accent-amber) !important;
      }
      
      /* ========================================
         QUALITY MENU
         ======================================== */
      #youtubeQuality { 
        pointer-events: auto !important; 
        z-index: 2000 !important;
      }
      #youtubeQuality:hover {
        background: rgba(147, 51, 234, 0.2) !important;
        border-color: #a855f7 !important;
        color: #a855f7 !important;
      }
      
      /* Subtitle Button */
      #addSubBtn:hover {
        background: rgba(236, 72, 153, 0.2) !important;
        border-color: #ec4899 !important;
        color: #ec4899 !important;
      }
      .quality-menu { 
        position: fixed; 
        background: var(--color-bg-elevated);
        backdrop-filter: blur(16px);
        border: 1px solid var(--color-border-medium); 
        border-radius: var(--radius-md); 
        display: none; 
        flex-direction: column; 
        width: 150px; 
        max-height: 240px; 
        overflow-y: auto; 
        z-index: 99999 !important; 
        padding: var(--space-sm); 
        box-shadow: var(--shadow-lg); 
        gap: var(--space-xs); 
        pointer-events: auto !important; 
      }
      .quality-option { 
        padding: var(--space-md) var(--space-lg); 
        color: var(--color-text-secondary); 
        background: transparent;
        border: none; 
        text-align: left; 
        cursor: pointer !important; 
        transition: all var(--transition-fast); 
        font-size: var(--font-size-md); 
        font-family: var(--font-sans);
        border-radius: var(--radius-sm); 
        pointer-events: auto !important; 
      }
      .quality-option:hover { background: rgba(0, 212, 255, 0.15); color: var(--color-text-primary); }
      .quality-option.active { background: rgba(0, 212, 255, 0.25); color: var(--color-accent-cyan); font-weight: 600; }
      .quality-empty { color: var(--color-text-muted); text-align: center; font-size: var(--font-size-sm); padding: var(--space-md); }
      
      /* ========================================
         TIPS SCREEN
         ======================================== */
      #tipsScreen { 
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        z-index: 15; 
        color: var(--color-text-primary); 
        padding: 0; 
        background: rgba(8, 10, 15, 0.95);
        backdrop-filter: blur(20px);
        max-height: 100vh; 
        overflow: auto; 
        overflow-x: hidden; 
      }
      #tipsHeader { 
        position: sticky; 
        top: 0; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: var(--space-lg) var(--space-xl); 
        background: var(--color-bg-primary);
        border-bottom: 1px solid var(--color-border-subtle); 
        font-weight: 600; 
        font-size: var(--font-size-lg); 
        font-family: var(--font-sans);
        letter-spacing: 0.3px; 
      }
      #tipsHeader span {
        color: var(--color-accent-cyan);
      }
      #tipsClose { 
        background: var(--color-bg-elevated); 
        color: var(--color-text-primary); 
        border: 1px solid var(--color-border-medium); 
        padding: var(--space-sm) var(--space-lg); 
        border-radius: var(--radius-md); 
        font-size: var(--font-size-md); 
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
      }
      #tipsClose:hover {
        background: rgba(255, 82, 82, 0.2);
        border-color: var(--color-accent-red);
      }
      #tipsBody { 
        padding: var(--space-xl); 
        font-size: 13px; 
        line-height: 1.7; 
      }
      #tipsBody ul {
        padding-left: 20px;
      }
      #tipsBody li { 
        color: var(--color-text-secondary);
        margin-bottom: var(--space-md);
      }
      #tipsBody b {
        color: var(--color-accent-cyan);
        font-weight: 600;
      }
      #loadLastPairBtn, #clearStorageBtn {
        background: var(--color-bg-elevated);
        border: 1px solid var(--color-border-medium);
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-md);
      }
      #loadLastPairBtn:hover {
        background: rgba(0, 230, 118, 0.15);
        border-color: var(--color-accent-green);
        color: var(--color-accent-green);
      }
      #clearStorageBtn:hover {
        background: rgba(255, 82, 82, 0.15);
        border-color: var(--color-accent-red);
        color: var(--color-accent-red);
      }
      
      /* ========================================
         TOAST NOTIFICATIONS
         ======================================== */
      .toast-container { 
        position: fixed; 
        top: 60px; 
        right: var(--space-lg); 
        z-index: 99999; 
        display: flex; 
        flex-direction: column; 
        gap: var(--space-md); 
        pointer-events: none; 
      }
      .toast { 
        background: var(--color-bg-elevated);
        backdrop-filter: blur(16px);
        color: var(--color-text-primary); 
        padding: var(--space-lg) var(--space-xl); 
        border-radius: var(--radius-md); 
        font-size: var(--font-size-lg); 
        font-family: var(--font-sans);
        max-width: 300px; 
        box-shadow: var(--shadow-lg); 
        border-left: 3px solid var(--color-accent-red); 
        pointer-events: auto; 
        animation: toastIn 0.3s ease; 
      }
      .toast.warning { border-left-color: var(--color-accent-amber); }
      .toast.info { border-left-color: var(--color-accent-cyan); }
      @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
      
      /* Sync Status */
      #syncStatus {
        position: fixed;
        top: var(--space-md);
        right: var(--space-md);
        background: var(--color-bg-primary);
        backdrop-filter: blur(12px);
        color: var(--color-text-primary);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        font-family: var(--font-mono);
        z-index: 9999;
        border: 1px solid var(--color-border-subtle);
      }
      
      /* Hidden elements */
      #timeRange, #timeRangeBase, #ReactVol, #BaseVol { display: none; }
      #BottomBar { display: none; }
      
      /* Debug Overlay */
      #debugOverlay {
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-subtle);
        border-radius: var(--radius-md);
      }
      
      /* ========================================
         RESPONSIVE DESIGN
         ======================================== */
      
      /* Large screens */
      @media (min-width: 1200px) {
        :root {
          --control-height: 46px;
          --control-btn-size: 32px;
        }
        .compact-time { min-width: 90px; }
        #baseVolumeSlider { width: 80px; }
      }
      
      /* Medium screens */
      @media (max-width: 1199px) and (min-width: 768px) {
        :root {
          --control-height: 40px;
          --space-lg: 10px;
        }
        .control-separator { display: none; }
        .control-group { gap: var(--space-xs); }
        #delayControls { gap: 2px; }
        #delay { min-width: 52px; font-size: var(--font-size-xs); }
        .delayLabel { display: none; }
      }
      
      /* Small screens */
      @media (max-width: 767px) {
        :root {
          --control-height: 38px;
          --control-btn-size: 26px;
          --control-btn-size-sm: 22px;
        }
        
        #baseVideoControls {
          flex-wrap: wrap;
          height: auto;
          padding: var(--space-sm) var(--space-md);
          gap: var(--space-sm);
        }
        
        .control-separator { display: none; }
        
        .control-group.playback-group { order: 1; }
        .control-group.seek-group { 
          order: 2; 
          flex: 1 1 100%;
          min-width: 100%;
        }
        .control-group.delay-group { order: 3; }
        .control-group.media-group { order: 4; }
        .control-group.sync-group { order: 5; }
        
        .delayLabel { display: none; }
        #delay { min-width: 48px; font-size: 8px; }
        
        .compact-time { 
          min-width: 60px; 
          font-size: 8px !important; 
        }
        
        #baseVolumeSlider { width: 40px; }
        
        #videoReactContainer {
          min-width: 150px;
          min-height: 85px;
        }
        
        .reactControls {
          height: 32px;
          padding: 0 var(--space-sm);
          gap: var(--space-sm);
        }
        
        #reactPlayPauseInner {
          width: 20px !important;
          height: 20px !important;
          min-width: 20px !important;
        }
        
        #reactTimeDisplay {
          font-size: 8px !important;
          min-width: 55px;
        }
        
        #reactVolumeSlider { width: 35px; }
      }
      
      /* Extra small screens */
      @media (max-width: 480px) {
        #baseVideoControls {
          padding: var(--space-xs) var(--space-sm);
        }
        
        .control-group.media-group #youtubeQuality,
        .control-group.media-group #addSubBtn {
          display: none;
        }
        
        #baseVolumeSlider { display: none; }
        
        .compact-btn {
          padding: 2px 4px !important;
          font-size: 8px !important;
        }
        
        .ultra-compact {
          min-width: 18px !important;
          height: 20px !important;
        }
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let holdDirection = 0;
        let holdStartTime = 0;
        let holdFrame = null;
        let lastStepTime = 0;

        function adjustDelay(direction, elapsed) {
          if (typeof window.setDelay !== 'function') return;
          const currentDelay = typeof window.videoReactDelay === 'number' ? window.videoReactDelay : 0;
          let increment = 0.1;
          if (elapsed > 2000) {
            increment = 1.0;
          } else if (elapsed > 1000) {
            increment = 0.5;
          }
          const next = Math.max(-300, Math.min(300, currentDelay + direction * increment));
          window.setDelay(parseFloat(next.toFixed(1)), true);
        }

        function tick(now) {
          if (!holdDirection) return;
          if (!lastStepTime) lastStepTime = now;
          if ((now - lastStepTime) >= 80) {
            adjustDelay(holdDirection, now - holdStartTime);
            lastStepTime = now;
          }
          holdFrame = requestAnimationFrame(tick);
        }

        function startHolding(direction) {
          if (holdDirection === direction) return;
          holdDirection = direction;
          holdStartTime = performance.now();
          lastStepTime = 0;
          adjustDelay(direction, 0);
          if (holdFrame) cancelAnimationFrame(holdFrame);
          holdFrame = requestAnimationFrame(tick);
        }

        function stopHolding() {
          holdDirection = 0;
          lastStepTime = 0;
          if (holdFrame) {
            cancelAnimationFrame(holdFrame);
            holdFrame = null;
          }
        }

        const decreaseBtn = document.getElementById('decreaseDelayBtn');
        decreaseBtn.addEventListener('mousedown', () => startHolding(-1));
        decreaseBtn.addEventListener('mouseup', stopHolding);
        decreaseBtn.addEventListener('mouseleave', stopHolding);
        decreaseBtn.addEventListener('touchstart', function(e) { e.preventDefault(); startHolding(-1); });
        decreaseBtn.addEventListener('touchend', function(e) { e.preventDefault(); stopHolding(); });
        decreaseBtn.addEventListener('touchcancel', stopHolding);

        const increaseBtn = document.getElementById('increaseDelayBtn');
        increaseBtn.addEventListener('mousedown', () => startHolding(1));
        increaseBtn.addEventListener('mouseup', stopHolding);
        increaseBtn.addEventListener('mouseleave', stopHolding);
        increaseBtn.addEventListener('touchstart', function(e) { e.preventDefault(); startHolding(1); });
        increaseBtn.addEventListener('touchend', function(e) { e.preventDefault(); stopHolding(); });
        increaseBtn.addEventListener('touchcancel', stopHolding);

        document.addEventListener('mouseup', stopHolding);
        document.addEventListener('touchend', stopHolding);
        document.addEventListener('touchcancel', stopHolding);
      });
    </script>
  </head>
  <body>
    <div id="videoReactContainer" class="ui-widget-content">
      <video id="videoReact" draggable="true" style="display:block;">
        <source src="" type="video/mp4">
      </video>
      <div id="videoReactYoutube" style="width:100%;height:calc(100% - 40px);display:none;"></div>
      <div id="reactDragHandle">DRAG</div>
      <div class="reactControls">
        <button id="reactPlayPauseInner" title="Play or pause the reaction video">‚èµ</button>
        <input type="range" id="reactSeekBar" min="0" max="100" value="0" step="any" title="Drag to jump to any time in the reaction video">
        <div id="reactTimeDisplay" class="timeDisplay" title="Current time / Total duration">0:00 / 0:00</div>
        <input type="range" id="reactVolumeSlider" min="0" max="1" value="1" step="any" title="Adjust reaction video volume">
      </div>
    </div>
    <div id="videoBaseContainer" style="width:100%;height:100%;position:relative;">
      <video id="videoBaseLocal" style="display:block;">
        <source src="" type="video/mp4">
      </video>
      <div id="videoBaseYoutube" style="width:100%;height:100%;display:none;"></div>
    </div>
    <div id="baseVideoControls">
      <!-- PLAYBACK GROUP: Source + Play -->
      <div class="control-group playback-group">
        <div class="video-source-dropdown">
          <button id="baseVideoSourceBtn" class="compact-btn" title="Load main video (local file or web link)">Base</button>
          <div id="baseVideoSourceMenu" class="video-source-menu">
            <button class="video-source-option" id="addBaseVideoLocal" title="Select a video file from your computer">Local</button>
            <button class="video-source-option" id="addBaseVideoLink" title="Enter YouTube URL or direct video link">Link</button>
          </div>
        </div>
        <button id="basePlayPause" title="Play or pause the main video">‚ñ∂</button>
      </div>
      
      <!-- SEEK GROUP: Timeline + Time -->
      <div class="control-group seek-group">
        <input type="range" id="baseSeekBar" min="0" max="100" value="0" step="any" title="Drag to jump to any time in the main video">
        <div id="baseTimeDisplay" class="compact-time" title="Current time / Total duration">0:00 / 0:00</div>
      </div>
      
      <div class="control-separator"></div>
      
      <!-- DELAY GROUP: Timing adjustment -->
      <div class="control-group delay-group">
        <div id="delayControls">
          <span class="delayLabel">Œî</span>
          <button id="decreaseDelayBtn" class="compact-btn ultra-compact" title="Make reaction video play earlier">‚àí</button>
          <span id="delay" title="Time difference between videos">0.0s</span>
          <span id="syncHealthDot" title="Sync health indicator"></span>
          <span id="delayValue" hidden>0.0</span>
          <button id="increaseDelayBtn" class="compact-btn ultra-compact" title="Make reaction video play later">+</button>
        </div>
      </div>
      
      <div class="control-separator"></div>
      
      <!-- MEDIA GROUP: React source + extras -->
      <div class="control-group media-group">
        <div class="video-source-dropdown">
          <button id="reactVideoSourceBtn" class="compact-btn" title="Load reaction video (local file or web link)">React</button>
          <div id="reactVideoSourceMenu" class="video-source-menu">
            <button class="video-source-option" id="addReactVidLocal" title="Select a reaction video file from your computer">Local</button>
            <button class="video-source-option" id="addReactVidLink" title="Enter YouTube URL or direct reaction video link">Link</button>
          </div>
        </div>
        <button id="addSubBtn" class="compact-btn ultra-compact" title="Load subtitle file (.srt format)">CC</button>
        <button id="youtubeQuality" class="compact-btn ultra-compact" title="Change YouTube video quality">Q</button>
        <input type="range" id="baseVolumeSlider" min="0" max="1" value="1" step="any" title="Adjust main video volume">
      </div>
      
      <div class="control-separator"></div>
      
      <!-- SYNC GROUP: Sync controls -->
      <div class="control-group sync-group">
        <button id="syncButton" class="compact-btn ultra-compact" title="Start syncing both videos together">S</button>
        <button id="desyncButton" class="compact-btn ultra-compact" title="Stop syncing - videos play independently">D</button>
        <button id="forceResyncButton" class="compact-btn ultra-compact" title="Force videos to sync again">FR</button>
        <button id="saveNowButton" class="compact-btn ultra-compact" title="Save current position, delay, volumes">üíæ</button>
      </div>
    </div>
    <div id="tipsScreen">
      <div id="tipsHeader"><span>reaction-sync v0.0.7 ‚Ä¢ Quick Start</span><div style="display:flex;gap:6px;align-items:center;"><button id="loadLastPairBtn">Load Last</button><button id="clearStorageBtn">Clear Saved</button><button id="tipsClose">Close</button></div></div>
      <div id="tipsBody">
        <ul>
          <li>Load <b>Base</b> and <b>React</b> videos from Local or Link (YouTube/direct/Real‚ÄëDebrid).</li>
          <li>Press <b>S</b> to sync, <b>D</b> to desync. Use <b>FR</b> to force re‚Äësync.</li>
          <li>Use <b>Space</b> to play/pause the focused video. Hover to reveal controls.</li>
          <li>Seek with Arrow keys. Hold <b>Shift</b> to target the base video.</li>
          <li>Adjust delay with the <b>‚àí / +</b> buttons. Hold to increase step speed.</li>
          <li>For YouTube, use <b>Q</b> to change quality. Serve over HTTP/HTTPS for best results.</li>
          <li>Drag the React window using the left handle. Resize from the bottom‚Äëright corner.</li>
          <li>Enable debug with <b>üêõ</b> or add <b>?debug=true</b> to the URL.</li>
        </ul>
      </div>
    </div>
    <div id="syncStatus" style="position:fixed;top:5px;right:5px;background:rgba(0,0,0,0.7);color:#fff;padding:5px 10px;border-radius:4px;font-size:12px;z-index:9999;"></div>
    <div id="toastContainer" class="toast-container"></div>
    <div id="debugOverlay" style="position:fixed;bottom:0;right:0;background:rgba(0,0,0,0.7);color:#0f0;font-size:12px;padding:5px;max-width:200px;max-height:150px;overflow:auto;display:none;z-index:9999"></div>
    <script>
      window.showToast = function(msg, type, duration) {
        type = type || 'error';
        duration = duration || 5000;
        var c = document.getElementById('toastContainer');
        if (!c) return;
        var t = document.createElement('div');
        t.className = 'toast ' + type;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(function() { try { c.removeChild(t); } catch(e) {} }, duration);
      };
    </script>
  </body>
</html>
